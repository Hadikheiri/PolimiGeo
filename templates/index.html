<!DOCTYPE html>
<html>
<head>
    <title>Province Data Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        #info {
            margin-top: 20px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-4">Province Data Map</h1>
        <div id="map" class="my-4"></div>
        <div id="info" class="my-4">
            <h2>Province Information</h2>
            <select id="province-select" class="form-select" onchange="fetchProvinceData()">
                <option value="">Select a province</option>
            </select>
            <div id="province-details" class="mt-4"></div>
            <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>
    <script>
        // Initialize the map
        var map = L.map('map').setView([41.9028, 12.4964], 6); // Center on Italy

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch and populate province select options
        fetch('/api/provinces')
            .then(response => response.json())
            .then(provinces => {
                const select = document.getElementById('province-select');
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    select.appendChild(option);
                });
            });

        // Fetch and display province data
        function fetchProvinceData() {
            const province = document.getElementById('province-select').value;
            if (!province) return;
            fetch(`/api/province/${province}`)
                .then(response => response.json())
                .then(data => {
                    const detailsDiv = document.getElementById('province-details');
                    detailsDiv.innerHTML = `
                        <h3>${data.provincia}</h3>
                        <p><strong>Region:</strong> ${data.regione}</p>
                        <p><strong>Population:</strong> ${data.pop_res011}</p>
                        <p><strong>Area:</strong> ${data.ar_kmq} kmÂ²</p>
                        <!-- Add more data points as needed -->
                    `;

                    // Chart.js visualization
                    const ctx = document.getElementById('chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                            datasets: [{
                                label: 'Population at Risk',
                                data: [data.pop_idr_p3, data.pop_idr_p2, data.pop_idr_p1],
                                backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(75, 192, 192, 0.2)'],
                                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
        }
    </script>
</body>
</html>
